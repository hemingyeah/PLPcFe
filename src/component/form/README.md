# Form组件设计文档
---

## 需求
目前系统中工单、事件、客户、产品模块均提供自定义表单的支持，未来也会对附加组件提供更强的自定义能力。因此需要一套表单组件能够满足以下需求：
- 提供多种自定义字段
- 提供对内置系统字段的支持
- 用户可根据自己需求自行配置表单
- 将部分模块配置项并入相应的字段配置中

## 目标
为满足以上需求，表单组件需要支持以下特性：
- 表单设计器可拖拽
- 表单设计器支持区分系统字段和自定义字段
- 字段类型可扩展、复用（每一部分）
- 提供统一的验证机制
- 提供统一的表单渲染机制
- 提供统一的表单展示机制
- 字段可在表单中或展示时支持自定义

## 组件结构
该组件主要由四个组件组成：`FormDesign`, `FormBuilder`, `FormView`, `FormItem`, 具体目录结构如下：
```
├── components            表单组件目录，所有类型的字段均维护在此目录下
├── mixin                 
├── util                  
├── common.scss           组件通用样式
├── config.js             常量
├── FormBuilder.js        表单构建器，提供统一的表单渲染机制      
├── FormDesign.js         表单设计器，提供表单设计能力  
├── FormField.js          表单字段对象
├── FormItem.vue          表单项，提供统一的验证能力
├── FormView.js           表单查看器，提供统一的展示机制
└── index.js              组件入口
```

## 组件中的三种字段

- `Field`： 该对象对应后端的字段对象，所有与后端交互的数据格式都应该符合该对象。
- `FormField`: 该对象主要用于组件内部。因为`Field`对象并不满足组件需要，因而定义了该对象，该对象一般都由`Field`对象转化而成。
- `FormTypeField`: 该对象没有定义具体的结构，主要用于导出各种类型的字段，该对象的具体说明见`components/README.md#字段类型结构`

## Mode属性说明
`mode`存在于`FormDesign`, `FormBuilder`两个组件中（作为`props`中的一个属性），目的是区分该组件用于哪个模块。设计`mode`属性主要基于以下几点考虑：

- 各个模块对字段的需求不一致，某些字段只适用于某一模块
- 可以根据该属性决定某个模块下显示某些类型的字段
- 同一类型的字段可能在不同模块下表现出不同的行为
- 用于对某一特定模块的系统字段自定义行为

## 表单验证机制
表单的验证机制依赖于`自定义事件`和`事件冒泡`。**表单构建器三层结构**: Form组件 => FormItem => FormBuilder。
- Form组件提供每种字段的具体实现
- FormItem主要用于验证
- FormBuilder作为容器，并提供整个表单的验证 

注册流程：
> 1. `Form组件`在挂载时触发 `form.add.field` 事件，将其注册到`FormItem`和`FormBuilder`中.
> 2. `FormItem`在收到`form.add.field`事件后，保存value用于取值（闭包），并在原参数上附加`validate`方法
> 3. `FormBuilder`在收到`form.add.field`事件后，保存`validate`方法，在提交表单时验证整个表单

验证流程：
> 1. Form组件中的值发生变化时，触发`form.validate`事件
> 2. FormItem接受到事件后，阻止事件冒泡并调用`validate`方法进行验证
> 3. 表单提交时，`FormBuilder`根据自身维护的`validateMap`触发整个表单的验证